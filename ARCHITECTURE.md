# アーキテクチャ文書

## 概要
社会科目入試問題分析システムは、レイヤード・アーキテクチャを採用し、関心事の分離と高い保守性を実現しています。

## ディレクトリ構造

```
social_exam_analyzer/
├── config/                 # 設定管理
│   ├── unified_settings.py # 統一設定
│   └── app_config.py      # アプリケーション設定
│
├── services/              # ビジネスロジック層
│   ├── analysis_service.py # 分析サービス
│   └── excel_service.py   # Excel出力サービス
│
├── gui/                   # プレゼンテーション層（GUI）
│   ├── main_window.py     # メインウィンドウ
│   └── analysis_window.py # 分析ウィンドウ
│
├── modules/               # ドメインモジュール
│   ├── unified_analyzer.py     # 統合分析エンジン
│   ├── gemini_bridge.py       # Gemini API連携
│   ├── ocr_handler.py         # OCR処理
│   └── social_excel_formatter.py # Excel出力
│
├── tests/                 # テスト
│   └── test_refactored_integration.py # 統合テスト
│
├── main_refactored.py     # 新エントリーポイント
└── main.py               # 旧エントリーポイント（移行中）
```

## アーキテクチャパターン

### 1. レイヤード・アーキテクチャ

```
┌─────────────────────────────────────┐
│   Presentation Layer (GUI/CLI)      │
├─────────────────────────────────────┤
│      Service Layer (Business)       │
├─────────────────────────────────────┤
│       Domain Layer (Models)         │
├─────────────────────────────────────┤
│   Infrastructure Layer (External)   │
└─────────────────────────────────────┘
```

### 2. 依存関係の方向

- 上位レイヤーは下位レイヤーに依存
- 下位レイヤーは上位レイヤーを知らない
- インターフェースを通じた疎結合

## 主要コンポーネント

### Config Layer（設定層）

#### UnifiedSettings
- **責任**: すべての設定を一元管理
- **パターン**: シングルトン
- **主要機能**:
  - 環境変数の読み込み
  - デフォルト設定の提供
  - 実行時設定の管理

### Service Layer（サービス層）

#### AnalysisService
- **責任**: 分析処理のオーケストレーション
- **主要機能**:
  - PDF分析の実行
  - 分析オプションの適用
  - 結果の構造化

### GUI Layer（プレゼンテーション層）

#### AnalysisWindow
- **責任**: ユーザーインターフェースの提供
- **主要機能**:
  - ファイル選択
  - オプション設定
  - 結果表示
  - Excel出力

### Domain Layer（ドメイン層）

#### UnifiedSocialAnalyzer
- **責任**: 社会科問題の分析ロジック
- **主要機能**:
  - 問題抽出
  - 分野判定
  - 出題形式検出
  - 統計計算

## データフロー

```mermaid
graph LR
    A[PDFファイル] --> B[OCRHandler]
    B --> C[テキストデータ]
    C --> D[UnifiedAnalyzer]
    D --> E[分析結果]
    E --> F[AnalysisService]
    F --> G[GUI/CLI]
    G --> H[ユーザー]
```

## 設計原則

### SOLID原則の適用

1. **単一責任の原則（SRP）**
   - 各クラスは1つの責任のみを持つ
   - 例: AnalysisServiceは分析のオーケストレーションのみ

2. **開放閉鎖の原則（OCP）**
   - 拡張に対して開いており、修正に対して閉じている
   - 新しい分析手法の追加が容易

3. **リスコフの置換原則（LSP）**
   - 派生クラスは基底クラスと置換可能
   - インターフェースベースの設計

4. **インターフェース分離の原則（ISP）**
   - クライアントが使用しないメソッドへの依存を強制しない
   - 小さく焦点を絞ったインターフェース

5. **依存性逆転の原則（DIP）**
   - 高レベルモジュールは低レベルモジュールに依存しない
   - 両方とも抽象に依存

## パフォーマンス考慮事項

### キャッシング
- OCR結果のキャッシング
- 分析結果のキャッシング

### 並列処理
- 複数PDFの並列分析
- 大問ごとの並列処理

### メモリ管理
- 大規模PDFの段階的処理
- 不要なオブジェクトの即座の解放

## セキュリティ考慮事項

### API キー管理
- 環境変数での管理
- .envファイルの使用
- Gitignoreでの除外

### 入力検証
- PDFファイルの検証
- ユーザー入力のサニタイゼーション

## 移行計画

### フェーズ1: 基盤構築（完了）
- ✅ 新アーキテクチャの設計
- ✅ 統一設定管理
- ✅ サービス層の実装
- ✅ 統合テストの作成

### フェーズ2: 段階的移行（進行中）
- ⏳ main.pyからmain_refactored.pyへの移行
- ⏳ 重複モジュールの統合
- ⏳ 未使用コードの削除

### フェーズ3: 最適化（未着手）
- ⬜ パフォーマンスチューニング
- ⬜ キャッシング実装
- ⬜ 並列処理の改善

## テスト戦略

### 単体テスト
- 各モジュールの独立テスト
- モックを使用した依存関係の分離

### 統合テスト
- エンドツーエンドのシナリオテスト
- 実際のPDFファイルを使用したテスト

### パフォーマンステスト
- 大規模PDFの処理時間測定
- メモリ使用量の監視

## 今後の拡張予定

1. **プラグインシステム**
   - カスタム分析手法の追加
   - 外部ツールとの連携

2. **Web API化**
   - RESTful APIの提供
   - マイクロサービス化

3. **機械学習統合**
   - 分野判定の精度向上
   - 自動問題分類

## 更新履歴

- 2024-01-18: 初版作成
- 2024-01-18: リファクタリング第1段階完了