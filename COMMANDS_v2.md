# 入試問題分析システム コマンドガイド v2.0

## システム概要
BunkoOCRで読み取ったテキストファイルを分析し、学校別・年度別の入試問題データベースを構築するシステムです。

## 起動方法

### 1. 自動起動（推奨）
```bash
# プロジェクトディレクトリで実行
python3 run_text_analyzer.py
```
- tkinterが利用可能な場合：GUI版が起動
- tkinterが利用できない場合：自動的にCLI版が起動

### 2. 個別分析（1件ずつ処理）

#### GUI版
```bash
python3 text_analyzer_app.py
```

#### CLI版
```bash
python3 text_analyzer_app_cli.py
```

### 3. バッチ処理（複数ファイルを一括処理）

#### GUI版
```bash
python3 batch_analyzer_gui.py
```
- 視覚的なインターフェースで操作
- リアルタイムの進捗表示
- 処理完了後、データベースとレポートを直接開ける

#### CLI版
```bash
# デフォルト（BunkoOCR結果フォルダを処理）
python3 batch_analyzer.py

# 過去問フォルダを処理
python3 batch_analyzer.py --kakomon

# カスタムディレクトリを処理
python3 batch_analyzer.py --dir /path/to/directory

# 逐次処理モード（並列処理を無効化）
python3 batch_analyzer.py --sequential

# ワーカー数を指定（デフォルト: 4）
python3 batch_analyzer.py --workers 8

# 組み合わせ例
python3 batch_analyzer.py --kakomon --workers 2 --sequential
```

## 使用方法

### 個別分析の操作手順

#### GUI版
1. **テキストファイルの選択**
   - 「ファイルを選択」ボタン：通常のファイル選択ダイアログ
   - 「BunkoOCR結果から選択」ボタン：最新のOCR結果から選択

2. **情報の確認**
   - 「情報を自動抽出」ボタンをクリック
   - 抽出された学校名・年度を確認
   - 必要に応じて手動で修正

3. **分析実行**
   - 「分析開始」ボタンをクリック
   - 確認ダイアログで「はい」を選択
   - 分析完了後、結果がExcelファイルに保存

#### CLI版
1. **ファイル選択方法を選択**
   ```
   【テキストファイル選択】
   1. 手動でファイルパスを入力
   2. BunkoOCR結果から選択
   3. 過去問フォルダから検索
   ```

2. **情報確認と修正**
   ```
   【抽出された情報】
   学校名: 女子学院中学校
   年度: 2023年
   
   情報は正しいですか？
   1. 正しい
   2. 修正する
   ```

3. **分析実行**
   - 最終確認後、分析が自動実行

### バッチ処理の操作手順

#### GUI版
1. **処理対象の選択**
   - BunkoOCR結果フォルダ
   - 過去問フォルダ
   - カスタムディレクトリ

2. **処理オプションの設定**
   - 並列処理の有効/無効
   - ワーカー数の指定（1-8）
   - 既存データのスキップ
   - バックアップの作成

3. **実行と結果確認**
   - 「バッチ処理を開始」ボタンをクリック
   - リアルタイムで進捗を確認
   - 完了後、データベースとレポートを確認

#### CLI版
コマンドラインオプションで指定して実行。
処理中は進捗が表示され、完了後にサマリーが出力されます。

## 出力ファイル

### メインデータベース
- **ファイル名**: `entrance_exam_database.xlsx`
- **構成**: 学校別シート
- **保存内容**:
  - 基本情報（年度、総文字数、大問数、総設問数）
  - 大問別情報（ジャンル、テーマ、著者、作品、設問数、文字数）
  - 設問タイプ別集計
  - 処理日時（バッチ処理の場合）

### バッチ処理レポート
- **ファイル名**: `batch_report_YYYYMMDD_HHMMSS.txt`
- **内容**:
  - 処理統計（成功/失敗件数）
  - 学校別・年度別の処理件数
  - エラー詳細（失敗したファイルの情報）

### 生テキスト保存（GUI版のみ）
- **シート名**: `{学校名}_{年度}_raw`
- **内容**: OCR結果の生テキスト（最大30,000文字）

## 主要な機能

### 1. 複数ファイル対応
- text1.txt, text2.txt など複数のOCR結果を自動結合
- ファイル名の番号順にソートして処理

### 2. 学校名・年度の自動認識
- ファイル名からの抽出
- テキスト内容からの抽出
- 和暦（平成・令和）対応
- 略称対応（例：渋渋 → 渋谷教育学園渋谷中学校）

### 3. 分析機能
- 大問構造の認識
- 設問タイプの分類（記述・選択・漢字語句・抜き出し）
- 文字数カウント
- 出典情報の抽出

### 4. データベース管理
- 既存データの更新対応
- 年度順の自動ソート
- 重複データの自動処理

### 5. バッチ処理特有の機能
- 自動グルーピング（同じフォルダ内のtext*.txtをグループ化）
- 並列処理（最大8ワーカーで高速処理）
- エラー耐性（個別のエラーがあっても処理継続）
- 詳細なログとレポート

## トラブルシューティング

### tkinterエラーの場合
```bash
# tkinterがインストールされていない場合は自動的にCLI版が起動します
python3 run_text_analyzer.py
```

### 文字コードエラーの場合
- ファイルがUTF-8でエンコードされていることを確認
- BunkoOCRの出力設定を確認

### ファイルが見つからない場合
- フルパスで指定するか、作業ディレクトリを確認
- BunkoOCR結果フォルダのパスを確認

### バッチ処理が遅い場合
- ワーカー数を調整（CPUコア数以下を推奨）
- 逐次処理モードを試す
- 大きなファイルを分割して処理

## 必要な環境

### Python パッケージ
```bash
pip install pandas openpyxl
```

### システム要件
- Python 3.8以上
- macOS（BunkoOCR使用のため）
- tkinter（GUI版のみ、標準でインストール済み）
- 十分なメモリ（バッチ処理時は特に重要）

## 設定ファイル

### batch_config.json
バッチ処理の詳細設定を管理：
```json
{
  "batch_processing": {
    "parallel_mode": true,
    "max_workers": 4,
    "timeout_seconds": 60
  },
  "school_mappings": {
    "渋渋": "渋谷教育学園渋谷中学校",
    ...
  }
}
```

## データの活用例

### Excelでの分析
1. 学校別シートで年度ごとの傾向を分析
2. ピボットテーブルで設問タイプの推移を可視化
3. 著者・作品の出題頻度を集計

### バッチ処理結果の活用
1. 複数校の横断的な分析
2. 年度別の出題傾向の比較
3. 学校群別の特徴抽出

## 注意事項

1. **OCR精度について**
   - BunkoOCRの認識精度に依存
   - 必要に応じて手動で修正

2. **データの保存**
   - 同じ学校・年度のデータは上書きされる
   - バックアップを推奨（GUI版では自動オプションあり）

3. **処理時間**
   - 大きなテキストファイルの場合、処理に時間がかかる
   - バッチ処理では並列処理で高速化可能

4. **メモリ使用量**
   - バッチ処理時は複数ファイルを同時処理するため、メモリ使用量が増加
   - 必要に応じてワーカー数を調整

## よくある使用シナリオ

### シナリオ1: 日々のOCR結果を処理
```bash
# GUI版で最新のOCR結果を確認しながら処理
python3 text_analyzer_app.py
```

### シナリオ2: 週末にまとめて処理
```bash
# バッチ処理で一週間分をまとめて処理
python3 batch_analyzer.py
```

### シナリオ3: 特定の学校フォルダを処理
```bash
# カスタムディレクトリを指定
python3 batch_analyzer.py --dir ~/Desktop/過去問/女子学院
```

### シナリオ4: 処理結果の確認と修正
```bash
# GUI版で個別に確認・修正
python3 text_analyzer_app.py
```

## サポート

問題が発生した場合：
1. エラーメッセージを確認
2. ログファイルを確認（バッチ処理の場合）
3. 設定ファイルを確認
4. 必要に応じて手動で個別処理