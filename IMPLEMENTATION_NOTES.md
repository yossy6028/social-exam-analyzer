# 実装ノート - 拡張版コンテンツ抽出機能

## 実装した機能（2025年1月）

### 1. 設問番号の連続性チェック機能
**ファイル**: `modules/question_validator.py`

#### 主要機能
- **連続性チェック**: 設問番号（問一〜問八）の欠落を検出
- **セクション統合**: 連続する設問を持つセクションを自動統合
- **警告生成**: 問題のあるセクションに対して具体的な警告メッセージ

#### 実装のポイント
```python
def check_continuity(self, questions: List[Dict]) -> Tuple[bool, List[str]]:
    # 漢数字を数値に変換
    # 番号の飛びを検出
    # 警告メッセージを生成
```

#### テスト結果
- ✅ 連続性の検出成功
- ✅ 問題のあるセクションの警告表示
- ✅ セクション統合機能の動作確認

### 2. PDFレイアウト解析機能
**ファイル**: `modules/pdf_layout_analyzer.py`

#### 主要機能
- **レイアウト検出**: 単一列/2段組みの自動判定
- **読み順決定**: 物理的な配置から正しい読み順を推定
- **ブロック分類**: テキスト、設問、出典、タイトルの自動分類

#### 実装のポイント
```python
def _determine_reading_order(self, blocks: List[TextBlock]) -> List[TextBlock]:
    # ページレイアウトを判定
    # 2段組みの場合は左列→右列の順
    # 設問が右列にある場合の特殊処理
```

#### 制限事項
- **画像ベースPDF**: 日本の入試問題PDFは主に画像形式
- **テキスト抽出不可**: PyMuPDFでは画像からテキスト抽出不可
- **OCR依存**: BunkoOCRなど外部OCRツールが必要

### 3. 統合版抽出モジュール
**ファイル**: `modules/enhanced_content_extractor.py`

#### 主要機能
- **自動検証**: 抽出後に自動で設問連続性を検証
- **自動修正**: 問題があれば自動でセクション統合
- **詳細レポート**: 分析結果の詳細レポートを生成

#### 使用方法
```python
from modules.enhanced_content_extractor import EnhancedContentExtractor

extractor = EnhancedContentExtractor()

# OCRテキストから分析
result = extractor.analyze_with_validation(text, school_name="学校名")

# PDFから分析（OCRテキストが必要）
result = extractor.extract_from_pdf(pdf_path)
```

## 解決した問題

### 問題1: セクション誤分割
- **原因**: OCRで設問が本文から分離、出典位置で機械的分割
- **解決**: 設問番号の連続性チェックで自動統合

### 問題2: レイアウト情報の欠如
- **原因**: OCRで2段組みが1列に変換
- **解決**: PDFレイアウト解析で物理配置を復元

## 今後の改善案

### 短期
- [ ] 学校別の設問パターン学習
- [ ] より高度な統合ロジック
- [ ] GUI統合

### 中期
- [ ] OCR統合（BunkoOCR API連携）
- [ ] 機械学習による大問境界検出
- [ ] リアルタイムプレビュー

### 長期
- [ ] 完全自動化パイプライン
- [ ] クラウドベース処理
- [ ] 多言語対応

## パフォーマンス

### 処理時間
- OCRテキスト分析: 1-2秒
- PDFレイアウト解析: 3-5秒（32ページ）
- 設問検証・統合: <1秒

### メモリ使用
- 通常: 50-100MB
- 大規模PDF: 200-300MB

## 注意事項

1. **PDFの形式**
   - 日本の入試問題は画像ベースが主流
   - テキストPDFは稀
   - OCR前処理が必須

2. **設問番号の形式**
   - 漢数字（問一、問二...）が一般的
   - 学校により異なる形式あり
   - 柔軟な対応が必要

3. **レイアウトの多様性**
   - 学校ごとに異なるレイアウト
   - パターンファイルは現実的でない
   - 汎用的なアルゴリズムが必要

## 使用ライブラリ
- PyMuPDF (fitz): PDFレイアウト解析
- pandas: データ処理
- openpyxl: Excel出力

## テスト済み環境
- Python 3.11.9
- macOS 14.5
- PyMuPDF 1.26.3