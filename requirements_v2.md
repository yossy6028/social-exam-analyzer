# 入試問題分析システム 要件定義書 v2.0

## 1. プロジェクト概要

### 1.1 背景
- 中学入試の国語問題を分析し、出題傾向をデータベース化する必要がある
- BunkoOCRで読み取ったテキストファイルを効率的に処理したい
- 学校別・年度別の出題傾向を把握し、指導に活用したい

### 1.2 目的
- OCR済みテキストファイルから入試問題の構造を自動分析
- 学校名・年度の自動認識と確認機能
- 分析結果のExcelデータベース化
- 出題傾向の可視化と検索機能

## 2. システム構成

### 2.1 処理フロー
```
1. テキストファイル選択
   ├─ 手動でファイルパスを指定
   ├─ BunkoOCR結果フォルダから選択
   └─ 過去問フォルダから検索

2. メタ情報抽出・確認
   ├─ 学校名の自動抽出（ファイル名/テキスト内容から）
   ├─ 年度の自動抽出（ファイル名/テキスト内容から）
   └─ ユーザーによる確認・修正

3. テキスト分析
   ├─ 大問構造の認識
   ├─ 設問タイプの分類
   ├─ 文字数カウント
   └─ 出典情報の抽出

4. データベース保存
   ├─ Excel形式で保存（1シート = 1学校）
   ├─ 年度順にソート
   └─ 既存データの更新対応

5. 分析結果の活用
   ├─ 傾向分析レポート
   ├─ 検索・フィルタリング
   └─ 統計情報の表示
```

### 2.2 入力データ
- **テキストファイル形式**
  - BunkoOCRで読み取った結果（text1.txt, text2.txt...）
  - UTF-8エンコーディング
  - 複数ファイルの結合対応

- **ファイル配置**
  - BunkoOCR結果: `~/Library/Mobile Documents/iCloud~info~lithium03~bunkoOCR/Documents/Results/`
  - 過去問フォルダ: `~/Desktop/01_仕事 (Work)/オンライン家庭教師資料/過去問/`

### 2.3 出力データ
- **Excelファイル**
  - ファイル名: `entrance_exam_database.xlsx`
  - シート構成: 学校別（例：開成中学校、女子学院中学校）
  - 列構成:
    - 基本情報: 年度、総文字数、大問数、総設問数
    - 大問別情報: ジャンル、テーマ、著者、作品、設問数、文字数
    - 設問タイプ別集計: 記述、選択、漢字・語句、抜き出し

## 3. 機能要件

### 3.1 ファイル選択機能
- **複数の選択方法**
  - ファイルダイアログによる選択（GUI版）
  - パス直接入力（CLI版）
  - BunkoOCR結果の自動検索（最新順表示）
  - キーワード検索（学校名、年度）

- **ファイル検証**
  - 存在確認
  - 読み取り権限確認
  - エンコーディング自動判定

### 3.2 メタ情報抽出機能
- **学校名認識**
  - パターンマッチング（正規表現）
  - 辞書ベースの認識
  - 略称対応（例：渋渋 → 渋谷教育学園渋谷中学校）

- **年度認識**
  - 西暦・和暦対応
  - 2桁年度の補完（23 → 2023）
  - ファイル名とテキスト内容の両方から抽出

- **確認画面**
  - 抽出結果の表示
  - 手動修正機能
  - 履歴からの選択

### 3.3 テキスト分析機能
- **構造認識**
  - 大問の区切り認識（一、二、三 / 1、2、3）
  - 設問番号の認識（問1、問2...）
  - 本文と設問の区別

- **設問分類**
  - 記述問題（字数制限の認識）
  - 選択問題（選択肢の認識）
  - 漢字・語句問題
  - 抜き出し問題

- **出典抽出**
  - 著者名の認識
  - 作品名の認識
  - 出版社情報

### 3.4 データベース管理機能
- **保存処理**
  - 新規追加
  - 既存データの更新
  - 重複チェック

- **データ整合性**
  - 年度の数値化
  - 必須項目の検証
  - エラーハンドリング

### 3.5 UI/UX要件
- **GUI版**
  - tkinterベースのデスクトップアプリ
  - プログレスバー表示
  - ドラッグ&ドロップ対応（将来）

- **CLI版**
  - 対話型インターフェース
  - 進捗表示
  - バッチ処理対応

## 4. 非機能要件

### 4.1 パフォーマンス
- 10MBのテキストファイルを10秒以内に処理
- 複数ファイルの並列処理対応（将来）

### 4.2 信頼性
- エラー時の graceful degradation
- 処理途中データの保存
- ログ出力

### 4.3 保守性
- モジュール化された設計
- 設定ファイルによるカスタマイズ
- テストコードの整備

### 4.4 セキュリティ
- ローカル環境での完結
- 個人情報の取り扱いなし
- ファイルアクセス権限の確認

## 5. 技術仕様

### 5.1 開発環境
- Python 3.8以上
- 主要ライブラリ:
  - pandas: データ処理
  - openpyxl: Excel操作
  - tkinter: GUI（標準ライブラリ）
  - pathlib: ファイルパス操作

### 5.2 ファイル構成
```
entrance_exam_analyzer/
├── text_analyzer_app.py        # GUI版メインアプリ
├── text_analyzer_app_cli.py    # CLI版メインアプリ
├── run_text_analyzer.py        # ランチャー
├── modules/
│   ├── text_analyzer.py        # テキスト分析モジュール
│   ├── pattern_extractor.py    # パターン抽出モジュール
│   └── excel_writer.py         # Excel出力モジュール
├── config/
│   └── settings.json           # 設定ファイル
└── data/
    └── output/                 # 出力ディレクトリ
```

## 6. バッチ処理機能

### 6.1 概要
複数の学校・年度のテキストファイルを一括で処理する機能を実装。大量のOCR結果を効率的に処理可能。

### 6.2 機能詳細
- **自動グルーピング**: BunkoOCR結果フォルダ内のtext*.txtファイルを自動的にグループ化
- **並列処理**: 複数のファイルグループを同時に処理（最大8ワーカー）
- **エラーハンドリング**: 個別のエラーがあっても処理を継続
- **進捗表示**: リアルタイムの進捗状況とログ表示
- **レポート生成**: 処理結果のサマリーレポートを自動生成

### 6.3 使用方法

#### CLI版
```bash
# デフォルト（BunkoOCR結果フォルダを処理）
python3 batch_analyzer.py

# 過去問フォルダを処理
python3 batch_analyzer.py --kakomon

# カスタムディレクトリを処理
python3 batch_analyzer.py --dir /path/to/directory

# 逐次処理モード（並列処理を無効化）
python3 batch_analyzer.py --sequential

# ワーカー数を指定
python3 batch_analyzer.py --workers 8
```

#### GUI版
```bash
python3 batch_analyzer_gui.py
```

### 6.4 バッチ処理の出力
- **データベース更新**: entrance_exam_database.xlsxに結果を統合
- **処理レポート**: batch_report_YYYYMMDD_HHMMSS.txt
- **エラーログ**: 処理できなかったファイルの詳細情報

## 7. 今後の拡張計画

### 7.1 Phase 1（完了）
- ✅ 基本的なテキスト分析機能
- ✅ Excel出力
- ✅ GUI/CLI両対応
- ✅ バッチ処理機能

### 7.2 Phase 2（開発中）
- 分析精度の向上
- 統計レポート生成の高度化
- 差分処理機能

### 7.3 Phase 3（計画中）
- 機械学習による分類精度向上
- Webインターフェース
- クラウド連携
- API提供

## 8. 制約事項
- OCR処理は手動（BunkoOCRの自動化は困難）
- macOS環境に特化
- 日本語縦書きテキストの処理に最適化

## 9. 成功基準
- 手動作業時間を50%以上削減
- 分析精度90%以上
- ユーザビリティテストでの満足度80%以上
- バッチ処理で100件以上のファイルを安定処理